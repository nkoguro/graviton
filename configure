#!/usr/bin/env gosh
;; Configuring graviton
;; Run ./configure (or gosh ./configure) to generate Makefiles.

(use gauche.config)
(use gauche.configure)
(use srfi-98)
(use util.match)

;; Here you can define handlers of configure arguments by cf-arg-enable
;; and cf-arg-with.  Note that --with-local is handled implicitly if you use
;; cf-init-gauche-extension.


;; Initialize configure.  This creates the global context, parses
;; command-line args and sets up default values.
(cf-init-gauche-extension)

;; Here you can add feature tests and other cf-define's.

(define wsl (let ((wslenv (get-environment-variable "WSLENV"))
                  (wsl-interop (get-environment-variable "WSL_INTEROP")))
              (cond
                ((and wslenv wsl-interop)
                 "2")
                (wslenv
                 "1")
                (else
                 #f))))

(cf-subst 'WSL (or wsl ""))

(cf-subst 'GRAVITON_PLAYER_ARCH
          (let1 platform (gauche-config "--arch")
            (match-let1 (arch os) (string-split platform "-" 1)
              (cond
                (wsl
                 "win32-x64")
                ((and (#/x86_64/i arch)
                      (#/linux/i os))
                 "linux-x64")
                ((and (#/x86_64/i arch)
                      (#/mingw/i os))
                 "win32-x64")
                ((and (#/x86/i arch)
                      (#/mingw/i os))
                 "win32-ia32")
                ((and (#/x86_64/i arch)
                      (#/darwin|macos/i os))
                 "darwin-x64")
                (else
                 "")))))

(cf-subst 'GRAVITON_PLAYER_EXECUTABLE
          (cond
            (wsl
             "graviton-player.exe")
            (else
             (string-join "graviton-player" (gauche-config 'executable-suffix) "."))))

;; Output
(cf-output-default "lib/graviton/config-alist.scm")

;; Local variables:
;; mode: scheme
;; end:
