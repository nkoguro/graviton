# General info
SHELL       = @SHELL@
prefix      = @prefix@
exec_prefix = @exec_prefix@
bindir      = @bindir@
libdir      = @libdir@
datadir     = @datadir@
datarootdir = @datarootdir@
srcdir      = @srcdir@
VPATH       = $(srcdir)

# These may be overridden by make invocators
DESTDIR        =
GOSH           = "@GOSH@"
GAUCHE_CONFIG  = "@GAUCHE_CONFIG@"
GAUCHE_PACKAGE = "@GAUCHE_PACKAGE@"
INSTALL        = "@GAUCHE_INSTALL@" -C
PKG_CONFIG     = pkg-config
LIBS	       = `$(PKG_CONFIG) --libs sdl2 SDL2_mixer SDL2_image`
CFLAGS	       = -I. `$(PKG_CONFIG) --cflags sdl2 SDL2_mixer SDL2_image`
PRECOMP        = $(GOSH) precomp

SOEXT	    = @SOEXT@
OBJEXT	    = @OBJEXT@
EXEEXT	    = @EXEEXT@
LOCAL_PATHS = "@LOCAL_PATHS@"

# Module-specific stuff
PACKAGE   = graviton

ARCHFILES = \
	graviton-common.$(SOEXT) \
	graviton-png.$(SOEXT) \
	graviton-async.$(SOEXT) \
	graviton-audio.$(SOEXT) \
	graviton-event.$(SOEXT) \
	graviton-video.$(SOEXT) \
	graviton.$(SOEXT)
SCMFILES  = $(srcdir)/graviton.scm
HEADERS   =

TARGET    = $(ARCHFILES)
GENERATED = graviton.sci graviton.c
CONFIG_GENERATED = Makefile

GAUCHE_PKGINCDIR  = "$(DESTDIR)@GAUCHE_PKGINCDIR@"
GAUCHE_PKGLIBDIR  = "$(DESTDIR)@GAUCHE_PKGLIBDIR@"
GAUCHE_PKGARCHDIR = "$(DESTDIR)@GAUCHE_PKGARCHDIR@"

graviton_SRCS = graviton.scm

.PHONY: all check install uninstall clean distclean maintainer-clean

all : $(TARGET)

png-lib.c: png-lib.scm
	$(PRECOMP) $<

graviton-png.$(SOEXT): graviton-png.c png-lib.c graviton.h
	$(GAUCHE_PACKAGE) compile --output=$@ --local=$(LOCAL_PATHS) --cflags="$(CFLAGS)" --libs="$(LIBS)" --verbose graviton-png graviton-png.c png-lib.c

common-lib.c: common-lib.scm
	$(PRECOMP) $<

graviton-common.$(SOEXT): graviton-common.c common-lib.c graviton.h
	$(GAUCHE_PACKAGE) compile --output=$@ --local=$(LOCAL_PATHS) --cflags="$(CFLAGS)" --libs="$(LIBS)" --verbose graviton-common graviton-common.c common-lib.c

async-lib.c: async-lib.scm types.scm
	$(PRECOMP) $<

graviton-async.$(SOEXT): graviton-async.c async-lib.c graviton.h
	$(GAUCHE_PACKAGE) compile --output=$@ --local=$(LOCAL_PATHS) --cflags="$(CFLAGS)" --libs="$(LIBS)" --verbose graviton-async graviton-async.c async-lib.c

image-lib.c: image-lib.scm types.scm
	$(PRECOMP) $<

window-lib.c: window-lib.scm types.scm
	$(PRECOMP) $<

sprite-lib.c: sprite-lib.scm types.scm
	$(PRECOMP) $<

tilemap-lib.c: tilemap-lib.scm types.scm
	$(PRECOMP) $<

draw-lib.c: draw-lib.scm types.scm
	$(PRECOMP) $<

graviton-video.$(SOEXT): graviton-video.c image-lib.c window-lib.c sprite-lib.c tilemap-lib.c draw-lib.c graviton.h
	$(GAUCHE_PACKAGE) compile --output=$@ --local=$(LOCAL_PATHS) --cflags="$(CFLAGS)" --libs="$(LIBS)" --verbose graviton-video graviton-video.c image-lib.c window-lib.c sprite-lib.c tilemap-lib.c draw-lib.c

event-lib.c: event-lib.scm types.scm enum2sym.scm
	$(PRECOMP) $<

graviton-event.$(SOEXT): graviton-event.c event-lib.c graviton.h
	$(GAUCHE_PACKAGE) compile --output=$@ --local=$(LOCAL_PATHS) --cflags="$(CFLAGS)" --libs="$(LIBS)" --verbose graviton-event graviton-event.c event-lib.c

music-lib.c: music-lib.scm types.scm
	$(PRECOMP) $<

sound-lib.c: sound-lib.scm types.scm
	$(PRECOMP) $<

graviton-audio.$(SOEXT): graviton-audio.c music-lib.c sound-lib.c graviton.h
	$(GAUCHE_PACKAGE) compile --output=$@ --local=$(LOCAL_PATHS) --cflags="$(CFLAGS)" --libs="$(LIBS)" --verbose graviton-audio graviton-audio.c music-lib.c sound-lib.c

graviton.sci graviton.c: $(graviton_SRCS)
	$(PRECOMP) -e $<

graviton.$(SOEXT): graviton.c graviton.h
	$(GAUCHE_PACKAGE) compile --output=$@ --local=$(LOCAL_PATHS) --cflags="$(CFLAGS)" --libs="$(LIBS)" --verbose graviton $<

enum2sym.scm:
	$(GOSH) ../scripts/genenum2sym > $@

install : all
	$(INSTALL) -m 444 -T $(GAUCHE_PKGINCDIR) $(HEADERS)
	$(INSTALL) -m 444 -T $(GAUCHE_PKGLIBDIR) $(SCMFILES)
	$(INSTALL) -m 555 -T $(GAUCHE_PKGARCHDIR) $(ARCHFILES)
	$(INSTALL) -m 444 -T $(GAUCHE_PKGLIBDIR)/.packages $(PACKAGE).gpd

uninstall :
	$(INSTALL) -U $(GAUCHE_PKGINCDIR) $(HEADERS)
	$(INSTALL) -U $(GAUCHE_PKGLIBDIR) $(SCMFILES)
	$(INSTALL) -U $(GAUCHE_PKGARCHDIR) $(ARCHFILES)
	$(INSTALL) -U $(GAUCHE_PKGLIBDIR)/.packages $(PACKAGE).gpd

clean :
	$(GAUCHE_PACKAGE) compile --clean graviton graviton.c
	rm -rf core $(TARGET) $(GENERATED) *.o *~ test.log so_locations

distclean : clean
	rm -rf $(CONFIG_GENERATED)

maintainer-clean : clean
	rm -rf $(CONFIG_GENERATED) configure VERSION

